.equ N_CONTEXT_REG, 31
.equ CONTEXT_SIZE, (N_CONTEXT_REG << 3)

.macro DUMP_REG reg, n
sd \reg, (\n << 3)(sp)
.endm

.macro RESTORE_REG reg, n
ld \reg, (\n << 3)(sp)
.endm

.macro DUMP_REGISTERS_INT
addi sp, sp, -CONTEXT_SIZE
DUMP_REG ra, 0
DUMP_REG sp, 1
DUMP_REG gp, 2
DUMP_REG tp, 3
DUMP_REG t0, 4
DUMP_REG t1, 5
DUMP_REG t2, 6
DUMP_REG s0, 7
DUMP_REG s1, 8
DUMP_REG a0, 9
DUMP_REG a1, 10
DUMP_REG a2, 11
DUMP_REG a3, 12
DUMP_REG a4, 13
DUMP_REG a5, 14
DUMP_REG a6, 15
DUMP_REG a7, 16
DUMP_REG s2, 17
DUMP_REG s3, 18
DUMP_REG s4, 19
DUMP_REG s5, 20
DUMP_REG s6, 21
DUMP_REG s7, 22
DUMP_REG s8, 23
DUMP_REG s9, 24
DUMP_REG s10, 25
DUMP_REG s11, 26
DUMP_REG t3, 27
DUMP_REG t4, 28
DUMP_REG t5, 29
DUMP_REG t6, 30
.endm

.macro RESTORE_REGISTERS_INT
RESTORE_REG ra, 0
RESTORE_REG sp, 1
RESTORE_REG gp, 2
RESTORE_REG tp, 3
RESTORE_REG t0, 4
RESTORE_REG t1, 5
RESTORE_REG t2, 6
RESTORE_REG s0, 7
RESTORE_REG s1, 8
RESTORE_REG a0, 9
RESTORE_REG a1, 10
RESTORE_REG a2, 11
RESTORE_REG a3, 12
RESTORE_REG a4, 13
RESTORE_REG a5, 14
RESTORE_REG a6, 15
RESTORE_REG a7, 16
RESTORE_REG s2, 17
RESTORE_REG s3, 18
RESTORE_REG s4, 19
RESTORE_REG s5, 20
RESTORE_REG s6, 21
RESTORE_REG s7, 22
RESTORE_REG s8, 23
RESTORE_REG s9, 24
RESTORE_REG s10, 25
RESTORE_REG s11, 26
RESTORE_REG t3, 27
RESTORE_REG t4, 28
RESTORE_REG t5, 29
RESTORE_REG t6, 30
addi sp, sp, CONTEXT_SIZE
.endm

.macro M_MODE_INTERRUPT_ENTRY
DUMP_REGISTERS_INT

mv      a0, sp
csrr    a1, mcause
csrr    a2, mstatus
csrr    a3, mepc
mv      a4, sp
.endm

.macro M_MODE_INTERRUPT_EXIT
csrr    t0, mepc
addi    t0, t0, 4
csrw    mepc, t0

RESTORE_REGISTERS_INT
.endm
